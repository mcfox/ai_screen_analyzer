<% # AI Screen Analyzer Component %>

<div>
  <!-- Botão flutuante para ativar análise -->
  <button 
    class="button"
    id="ai-analyzer-trigger"
    title="Clique para analisar a tela com IA"
  >
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="1"></circle>
      <path d="M12 1v6m0 6v6"></path>
      <path d="M4.22 4.22l4.24 4.24m5.08 5.08l4.24 4.24"></path>
      <path d="M1 12h6m6 0h6"></path>
      <path d="M4.22 19.78l4.24-4.24m5.08-5.08l4.24-4.24"></path>
    </svg>
    <%= button_text %>
  </button>

  <!-- Barra lateral com resultado da análise -->
  <div class="ai-analyzer-sidebar" id="ai-analyzer-sidebar">
    <div class="ai-analyzer-header">
      <h3><%= sidebar_title %></h3>
      <button class="ai-analyzer-close" id="ai-analyzer-close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="ai-analyzer-content" id="ai-analyzer-content">
      <div class="ai-analyzer-loading" id="ai-analyzer-loading" style="display: none;">
        <div class="spinner"></div>
        <p>Analisando tela com IA...</p>
      </div>
      <div class="ai-analyzer-result" id="ai-analyzer-result" style="display: none;"></div>
      <div class="ai-analyzer-error" id="ai-analyzer-error" style="display: none;"></div>
    </div>
  </div>

  <!-- Overlay para fechar sidebar -->
  <div class="ai-analyzer-overlay" id="ai-analyzer-overlay"></div>
</div>

<style>
  .ai-screen-analyzer-container {
    position: fixed;
    z-index: 9998;
  }

  /* Botão flutuante */
  .ai-analyzer-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    transition: all 0.3s ease;
    font-size: 0;
    padding: 0;
  }

  .ai-analyzer-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
  }

  .ai-analyzer-button:active {
    transform: scale(0.95);
  }

  .ai-analyzer-button svg {
    width: 24px;
    height: 24px;
  }

  /* Overlay */
  .ai-analyzer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9997;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .ai-analyzer-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }

  /* Barra lateral */
  .ai-analyzer-sidebar {
    position: fixed;
    right: 0;
    top: 0;
    width: 400px;
    height: 100vh;
    background: white;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.15);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    overflow: hidden;
  }

  .ai-analyzer-sidebar.active {
    transform: translateX(0);
  }

  @media (max-width: 768px) {
    .ai-analyzer-sidebar {
      width: 100%;
    }
  }

  /* Header da sidebar */
  .ai-analyzer-header {
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .ai-analyzer-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
  }

  .ai-analyzer-close {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease;
  }

  .ai-analyzer-close:hover {
    opacity: 0.8;
  }

  /* Conteúdo da sidebar */
  .ai-analyzer-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }

  /* Loading spinner */
  .ai-analyzer-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e5e7eb;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .ai-analyzer-loading p {
    margin-top: 16px;
    color: #6b7280;
    font-size: 14px;
  }

  /* Resultado */
  .ai-analyzer-result {
    color: #374151;
    font-size: 14px;
    line-height: 1.6;
  }

  .ai-analyzer-result h4 {
    color: #667eea;
    margin-top: 16px;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 600;
  }

  .ai-analyzer-result p {
    margin: 0 0 12px 0;
  }

  .ai-analyzer-result ul,
  .ai-analyzer-result ol {
    margin: 8px 0 12px 20px;
    padding: 0;
  }

  .ai-analyzer-result li {
    margin-bottom: 6px;
  }

  /* Erro */
  .ai-analyzer-error {
    background: #fee2e2;
    border: 1px solid #fecaca;
    border-radius: 6px;
    padding: 12px;
    color: #991b1b;
    font-size: 14px;
    line-height: 1.5;
  }

  /* Scrollbar customizado */
  .ai-analyzer-content::-webkit-scrollbar {
    width: 6px;
  }

  .ai-analyzer-content::-webkit-scrollbar-track {
    background: #f3f4f6;
  }

  .ai-analyzer-content::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 3px;
  }

  .ai-analyzer-content::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const triggerButton = document.getElementById('ai-analyzer-trigger');
    const sidebar = document.getElementById('ai-analyzer-sidebar');
    const closeButton = document.getElementById('ai-analyzer-close');
    const overlay = document.getElementById('ai-analyzer-overlay');
    const loadingEl = document.getElementById('ai-analyzer-loading');
    const resultEl = document.getElementById('ai-analyzer-result');
    const errorEl = document.getElementById('ai-analyzer-error');

    const prompt = '<%= prompt %>';

    function openSidebar() {
      sidebar.classList.add('active');
      overlay.classList.add('active');
    }

    function closeSidebar() {
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
    }

    function showLoading() {
      loadingEl.style.display = 'flex';
      resultEl.style.display = 'none';
      errorEl.style.display = 'none';
    }

    function showResult(html) {
      loadingEl.style.display = 'none';
      resultEl.style.display = 'block';
      errorEl.style.display = 'none';
      resultEl.innerHTML = html;
    }

    function showError(message) {
      loadingEl.style.display = 'none';
      resultEl.style.display = 'none';
      errorEl.style.display = 'block';
      errorEl.innerHTML = `<strong>Erro:</strong> ${message}`;
    }

    async function captureAndAnalyzeScreen() {
      openSidebar();
      showLoading();

      try {
        // Carregar html2canvas dinamicamente
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        
        script.onload = async function() {
          try {
            const canvas = await html2canvas(document.body, {
              allowTaint: true,
              useCORS: true,
              scale: 1,
              backgroundColor: '#ffffff'
            });

            const imageData = canvas.toDataURL('image/jpeg', 0.8);

            // Enviar para backend
            const response = await fetch('/ai_screen_analyzer/analyze-screen', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
              },
              body: JSON.stringify({
                image: imageData,
                prompt: prompt
              })
            });

            if (!response.ok) {
              throw new Error(`Erro ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (data.success) {
              // Converter markdown para HTML simples
              const html = data.analysis
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^- (.*?)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

              showResult(`<p>${html}</p>`);
            } else {
              showError(data.error || 'Erro ao analisar a tela');
            }
          } catch (error) {
            showError(error.message || 'Erro ao capturar a tela');
          }
        };

        document.head.appendChild(script);
      } catch (error) {
        showError(error.message || 'Erro desconhecido');
      }
    }

    triggerButton.addEventListener('click', captureAndAnalyzeScreen);
    closeButton.addEventListener('click', closeSidebar);
    overlay.addEventListener('click', closeSidebar);
  });
</script>
